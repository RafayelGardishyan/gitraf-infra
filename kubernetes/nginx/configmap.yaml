apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: gitraf
  labels:
    app.kubernetes.io/name: nginx
    app.kubernetes.io/component: reverse-proxy
data:
  # IMPORTANT: Replace placeholder values before deployment:
  # - PUBLIC_IP: Your server's public IP address
  # - DOMAIN: Your git server domain (e.g., git.example.com)
  # - PAGES_DOMAIN: Your pages wildcard domain (e.g., example.com for *.example.com)
  nginx.conf: |
    events {
        worker_connections 1024;
    }
    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        map $http_upgrade $connection_upgrade {
            default upgrade;
            ''      close;
        }

        # Git server - replace DOMAIN with your git server domain
        server {
            listen PUBLIC_IP:80;
            server_name DOMAIN;
            location /.well-known/acme-challenge/ { root /var/www/certbot; }
            location / { return 301 https://$host$request_uri; }
        }

        server {
            listen PUBLIC_IP:443 ssl;
            http2 on;
            server_name DOMAIN;

            ssl_certificate     /etc/letsencrypt/live/DOMAIN/fullchain.pem;
            ssl_certificate_key /etc/letsencrypt/live/DOMAIN/privkey.pem;

            client_max_body_size 500m;

            # LFS requests go to gitraf-server
            location ~ ^/[^/]+\.git/info/lfs/ {
                proxy_pass http://127.0.0.1:8081;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_request_buffering off;
            }

            # Git HTTP requests go to ogit
            location ~ ^/[^/]+\.git(/.*)?$ {
                proxy_pass http://127.0.0.1:30081;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # All other requests go to gitraf-server
            location / {
                proxy_pass http://127.0.0.1:8081;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }

        # Pages - *.PAGES_DOMAIN (wildcard)
        server {
            listen PUBLIC_IP:80;
            server_name *.PAGES_DOMAIN;
            location /.well-known/acme-challenge/ { root /var/www/certbot; }
            location / { return 301 https://$host$request_uri; }
        }

        server {
            listen PUBLIC_IP:443 ssl default_server;
            http2 on;
            server_name *.PAGES_DOMAIN;

            # Update this path to match your Let's Encrypt certificate location
            ssl_certificate     /etc/letsencrypt/live/PAGES_DOMAIN-0001/fullchain.pem;
            ssl_certificate_key /etc/letsencrypt/live/PAGES_DOMAIN-0001/privkey.pem;

            # Extract subdomain from host
            set $subdomain "";
            if ($host ~ ^(.+)\.PAGES_DOMAIN$) {
                set $subdomain $1;
            }

            root /opt/ogit/pages/$subdomain/site;
            index index.html index.htm;

            location / {
                try_files $uri $uri/ $uri.html =404;
            }

            error_page 404 /404.html;

            location = /robots.txt {
                try_files $uri @default_robots;
            }

            location @default_robots {
                return 200 "User-agent: *\nDisallow: /\n";
                add_header Content-Type text/plain;
            }
        }
    }
